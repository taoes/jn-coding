---
title: 聊一聊系统架构中的负载均衡
date: 2021-11-21 17:49:28
tags:
author: 枕上江南
urlName: system_load_balance
cover: https://ppoffice.github.io/hexo-theme-icarus/gallery/covers/vector_landscape_3.svg
---

负载均衡(Load Balance) 指的是将请求根据分派算法分摊到多个操作单元上处理。负载均衡的关键词在于均衡(注意，这里说的是均衡而不是均匀)。负载均衡主要解决的是单点系统的性能问题以及非高可用的问题。<br />

<!--more-->

# 1、负载均衡算法
常见的复杂均衡算法包括轮询法，随机发，最小连接法，一致性哈希算法等等。

## 1.轮询法

轮询法，就是将用户的请求轮流分配给服务器，就像是挨个数数，轮流分配。这种算法比较简单，他具有绝对均衡的优点，但是也正是因为绝对均衡它必须付出很大的代价，例如它无法保证分配任务的合理性，无法根据服务器承受能力来分配任务。<br />

## 2. 加权轮询法

普通的轮询法要求设备具有相同的性能，如果设备的性能并不是全相同，可能会造成有的配置低的设备负载较高，配置高的设备负载较低，因此对于这种情况使用加权轮询的方是一个非常好的方式。<br />

## 3. 随机法

随机法，是随机选择一台服务器来分配任务。它保证了请求的分散性达到了均衡的目的。同时它是没有状态的不需要维持上次的选择状态和均衡因子[5]。但是随着任务量的增大，它的效果趋向轮询后也会具有轮询算法的部分缺点。<br />

## 4. 加权随机算法

同加权轮询法类似，加权随机法也根据后端机器的配置，系统的负载分配不同的权重。不同的是，它是按照权重随机请求后端服务器，而非顺序    <br />

##  5. 最小连接法

最小连接法，将任务分配给此时具有最小连接数的节点，因此它是动态负载均衡算法。一个节点收到一个任务后连接数就会加1，当节点故障时就将节点权值设置为0，不再给节点分配任务。<br />

## 6. 源地址哈希

源地址哈希的思想是根据获取客户端的IP地址，通过哈希函数计算得到的一个数值，用该数值对服务器列表的大小进行取模运算，得到的结果便是客服端要访问服务器的序号。采用源地址哈希法进行负载均衡，同一IP地址的客户端，当后端服务器列表不变时，它每次都会映射到同一台后端服务器进行访问。<br />

# 2、负载均衡实现方案

## 2.1 基于DNS实现负载均衡
在域名提供商的域名解析出配置，将域名解析到多个IP上，就可以基于DNS实现负载均衡，每次客户端从DNS出获取域名对应的IP地址，根据一定的算法，DNS服务会返回不同的IP，从而实现负载均衡。<br />


<img src="https://pic.zhoutao123.com/bl-dns.png" alt="bl_dns" width="500px"/>


## 2.2 基于反向代理实现负载均衡
反向代理也是实现负载均衡的不错的方案，常见的服务器，比如Nginx 以及Caddy等Web服务器均可以实现反向代理，可通过反向代理的方式，通过负载均衡算法，指定到不同的服务器上，其结果图如下图所示。<br />

<img src="https://pic.zhoutao123.com/bl-proxy.png" alt="bl_dns" width="500px">


### 2.3 基于NAT（Network Address Translation）的负载均衡技术
该技术通过一个地址转换网关将每个外部连接均匀转换为不同的内部服务器地址，因此外部网络中的计算机就各自与自己转换得到的地址上的服务器进行通信，从而达到负载均衡的目的。其中网络地址转换网关位于外部地址和内部地址之间，不仅可以实现当外部客户机访问转换网关的某一外部地址时可以转发到某一映射的内部的地址上，还可使内部地址的计算机能访问外部网络。


# 3、系统中的负载均衡

软件系统中，我们常用的负载均衡技术主要从，客户端到代理服务器的负载均衡，代理服务器到站点层的负载均衡，服务层的负载均衡以及数据库的负载均衡。<br />

- 客户端到代理服务器的负载均衡主要是通过DNS服务器实现负载均衡的，如2.1 节的基于DNS实现负载均衡

+ 代理服务器到站点层主要通过反向代理实现负载均衡，比如常见的Nginx反向代理

+ 站点层到服务层的负载均衡主要通过远程服务调用，通过在注册中心注册服务，客户端发起请求时候实现负载均衡，比如Dubbo等等

+ 服务层到数据库层的负载均衡主要通过数据库的读写分离和分库分表实现，通过分库分表，请服务层的数据处理执行不同数据库实例。




